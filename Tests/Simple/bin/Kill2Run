#!/bin/bash

# Test system behaviour for jobs that are killed while queued

PORT=5005

module load python-tools
# Start server
$HOME/Soft/WebServices/AppServer/cisapps start
# Start gateway
(setsid $HOME/Soft/WebServices/AppGateway/cisappg $PORT > CISAppGateway.log 2>&1) &
GATEPID=$!

sleep 5

# Submit job
# Use the WaitSet - it should queue infinitely due to unreasonable resource request
ID=$(curl -s -S -X POST -H "Content-type: application/json" http://localhost:$PORT/submit -d \
    '{"service":"Test", "api":"1.0", "input":{"WaitSet":"1"}}')
# Expect Waiting
curl -s -S http://localhost:$PORT/status/$ID
echo ""

sleep 20

# Expect Queued
curl -s -S http://localhost:$PORT/status/$ID
echo ""

# Kill the job - simulates cluster shutdown or admin intervention
qdel $(cat $TEXTTEST_SANDBOX/PBS/Queue/$ID)

sleep 20

# Expect Killed
curl -s -S http://localhost:$PORT/status/$ID

# Stop server
$HOME/Soft/WebServices/AppServer/cisapps terminate
# Stop gateway
kill -TERM -$GATEPID

