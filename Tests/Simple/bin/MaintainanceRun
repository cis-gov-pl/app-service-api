#!/bin/bash

# Test clean test job execution with options from option set

module load python-tools
# Start server
$HOME/Soft/WebServices/AppServer/cisapps start
# Start gateway
($HOME/Soft/WebServices/AppGateway/cisappg > CISAppGateway.log 2>&1) &

sleep 3

# Submit job
# Use the default options
ID=$(curl -s -S -X POST -H "Content-type: application/json" http://localhost:5000/submit -d \
    '{"service":"Test"}')
# Expect Waiting
curl -s -S http://localhost:5000/status/$ID
echo ""

sleep 15

# Expect Running
curl -s -S http://localhost:5000/status/$ID
echo ""

# Simulate clean restart - pause queue
$HOME/Soft/WebServices/AppServer/cisapps pause

sleep 65

# Expect Done
curl -s -S http://localhost:5000/status/$ID
echo ""

# Submit job
# Use the CleanSet for standard options
ID=$(curl -s -S -X POST -H "Content-type: application/json" http://localhost:5000/submit -d \
    '{"service":"Test", "CleanSet":"1"}')
# Expect Waiting
curl -s -S http://localhost:5000/status/$ID
echo ""

sleep 15

# Expect Waiting
curl -s -S http://localhost:5000/status/$ID
echo ""

# Simulate clean restart - restart
$HOME/Soft/WebServices/AppServer/cisapps restart

sleep 40

# Expect Done
curl -s -S http://localhost:5000/status/$ID
echo ""

# Stop server
$HOME/Soft/WebServices/AppServer/cisapps terminate
# Stop gateway (we use "axww" to make sure ps does not truncate command line options)
ps axww | grep cisappg | grep -v grep | awk '{print $1}' | xargs kill

